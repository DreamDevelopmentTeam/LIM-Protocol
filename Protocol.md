# TLIM通讯协议

> **TCP** LAN Instant Messaging Protocol

此版本的TLIM使用UDP广播进行服务端发现，以稳定可靠的TCP进行数据传输。

客户端和服务器之间通过发送**二进制的格式化JSON字段**进行数据交换。

---

## 端口规范

此版本**服务端发现协议**端口为**65000/UDP**（仅客户端查找服务端使用）。

此版本**服务端**端口为**65000/TCP**（数据交换使用）。

服务端端口绑定案例：("0.0.0.0", 65000)

| 参数 | 值 |
| --- | --- |
| 端口 | 65000/TCP+UDP |
| 方式 | C->S/中心化 |
| 验证 | ID/密码 |
| 跨网 | 支持（指定服务端地址） |

--- 

## 网络消息格式

一般地，正常的通信信息格式如下：

```json
{
  "type" : 0,
  "data": {}
}
```

| 字段 | 作用 |
| --- | --- |
| type | 消息类型 |
| data | 消息数据 |

**消息编码格式：UTF-8**


在双方发送消息数据时，先将消息数据转换为**格式化的JSON字符串**，然后使用本协议规定的编码格式编码为**二进制字节集**，并通过网络发送。

与之对应的，如果某一方在接收数据报的时候无法通过反向操作还原原始数据（或在还原过程中发生异常），则丢弃该数据。

> 为了确保通信安全性，规定客户端与服务端进行通信之前需要先进行**公钥交换**和**加密通信测试**，并**在后续的通信中使用RSA加密原始数据**并发送加密后的密文。
> 如果**加密通信测试未通过**，则双方断开各自的连接。
> 如果**启用加密但收到了无法成功解密的数据包**，则将该数据包进行丢弃。


**加密算法规定：RSA**

---

## 聊天分离隔离

网络ID（Network ID）的作用是在同一局域网分割不同的聊天区域。

节点收到数据包时应首先校验网络ID，并丢弃与自身网络ID不符的数据包。

网络ID规范：

1. 只能由数字构成
2. 网络ID应为大于0的整数
3. 网络ID默认为0


---

## 用户与操作名称

当节点收到类型非普通消息的数据报文时，应当执行对应的操作。

| 字段 | 作用 |
| --- | --- |
| type < 0 | 无效操作/未知操作 |
| type = 0 | 普通消息 |
| type = 1 | 客户端发现协议FCP（Find Client Protocol） |
| type = 2 | 管理员控制协议ACP（Network Console Protocol） |
| type = 3 | 主机地址获取协议HAGP（Host Address Get Protocol） |
| type = 4 | 普通控制消息 |


### 协议详细信息

> #### 客户端发现协议FCP（Find Client Protocol）

收到协议报文（且字段name="find"）后，向发送端发送一条回复信息：

**JSON中其他参数略**
```json
"type": 1,
"name": "return",
"msg": "节点的用户名"
```
---

## 用户名命名规范

用户名不能为空，不能仅包含空格，不允许包含制表符/换行符。

**规定以下字符串（不区分大小写）不能被用于用户名（系统预留）：**
1. admin
2. system
3. sys
4. fcp
5. lim
6. core
7. console
8. protocol
9. acp
10. hagp
11. p2p


**规定包含以下字符串（不区分大小写）的字符串不能被用于用户名（敏感词）：**
1. **刘金玉**
2. **刘国强**
3. **林爽爽**


---

---

## 预览/待定功能

预览或待定的功能，可能在将来提供支持或作废。


---

## Todo List

可能会在将来添加支持或预览/待定的功能，可能在将来提供完整的支持或作废。

**(待定)** TodoList：

| 功能 | 作用 | 状态 |
| --- | --- | --- |
| 黑名单共识协议 | P2P/去中心化网络管理 | 待定 |
| 管理员共识协议 | 管理/维护/保障网络运行 | 待定 |
| 私有信息交换协议 | 私聊/组播支持 | 未完成 |
| 主机地址获取协议 | 获取节点本机IP地址 | 未完成 |








